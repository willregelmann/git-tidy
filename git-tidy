#!/bin/bash
# git-tidy — Delete local branches fully merged into the default branch.
# Place on PATH (or symlink) to use as: git tidy

set -euo pipefail

dry_run=false
delete_remote=false
skip_confirm=false
base_branch=""

# Expand combined short flags (e.g. -rn -> -r -n)
expanded=()
for arg in "$@"; do
    if [[ "$arg" =~ ^-[a-zA-Z]{2,}$ ]]; then
        for (( i=1; i<${#arg}; i++ )); do
            expanded+=("-${arg:$i:1}")
        done
    else
        expanded+=("$arg")
    fi
done

i=0
while [[ $i -lt ${#expanded[@]} ]]; do
    arg="${expanded[$i]}"
    case "$arg" in
        -n|--dry-run) dry_run=true ;;
        -r|--remote) delete_remote=true ;;
        -y|--yes) skip_confirm=true ;;
        -b|--base)
            i=$((i + 1))
            if [[ $i -ge ${#expanded[@]} ]]; then
                echo "Option $arg requires a branch name" >&2
                exit 1
            fi
            base_branch="${expanded[$i]}"
            ;;
        --base=*)
            base_branch="${arg#--base=}"
            ;;
        -h|--help)
            echo "Usage: git tidy [-n|--dry-run] [-r|--remote] [-y|--yes] [-b|--base <branch>]"
            echo ""
            echo "Delete local branches fully merged into the default branch."
            echo ""
            echo "Options:"
            echo "  -n, --dry-run        Show which branches would be deleted without deleting them"
            echo "  -r, --remote         Delete merged branches from the remote instead of local"
            echo "  -y, --yes            Skip confirmation prompt"
            echo "  -b, --base <branch>  Branch to compare against (default: auto-detected from remote)"
            exit 0
            ;;
        *)
            echo "Unknown option: $arg" >&2
            exit 1
            ;;
    esac
    i=$((i + 1))
done

# Detect default branch if not specified
if [[ -n "$base_branch" ]]; then
    default_branch="$base_branch"
else
    default_branch=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@') || true
    if [[ -z "$default_branch" ]]; then
        if git show-ref --verify --quiet refs/remotes/origin/main; then
            default_branch="main"
        elif git show-ref --verify --quiet refs/remotes/origin/master; then
            default_branch="master"
        else
            echo "Could not determine default branch." >&2
            exit 1
        fi
    fi
fi

git fetch origin --prune --quiet || true

current=$(git branch --show-current)
candidates=()

# Collect candidates
if $delete_remote; then
    for ref in $(git for-each-ref --format='%(refname:short)' refs/remotes/origin/); do
        branch="${ref#origin/}"
        [[ "$branch" == "$default_branch" ]] && continue
        [[ "$branch" == "HEAD" ]] && continue

        ahead=$(git rev-list --count "origin/${default_branch}".."$ref" 2>/dev/null) || continue
        [[ "$ahead" == "0" ]] && candidates+=("$branch")
    done
else
    for branch in $(git for-each-ref --format='%(refname:short)' refs/heads/); do
        [[ "$branch" == "$current" ]] && continue
        [[ "$branch" == "$default_branch" ]] && continue

        ahead=$(git rev-list --count "origin/${default_branch}".."$branch" 2>/dev/null) || continue
        [[ "$ahead" == "0" ]] && candidates+=("$branch")
    done
fi

if [[ ${#candidates[@]} -eq 0 ]]; then
    echo "No merged branches to clean up."
    exit 0
fi

# Dry run — just print and exit
if $dry_run; then
    echo "Would delete ${#candidates[@]} merged branch(es):"
    printf '  %s\n' "${candidates[@]}"
    exit 0
fi

# Confirm unless --force
if ! $skip_confirm; then
    echo "Will delete ${#candidates[@]} merged branch(es):"
    printf '  %s\n' "${candidates[@]}"
    printf "Proceed? [y/N] "
    read -r answer
    if [[ "$answer" != [yY] ]]; then
        echo "Aborted."
        exit 0
    fi
fi

# Delete
deleted=()
if $delete_remote; then
    for branch in "${candidates[@]}"; do
        if git push origin --delete "$branch" &>/dev/null; then
            deleted+=("$branch")
        fi
    done
else
    for branch in "${candidates[@]}"; do
        if git branch -d "$branch" &>/dev/null; then
            deleted+=("$branch")
        fi
    done
fi

if [[ ${#deleted[@]} -gt 0 ]]; then
    echo "Deleted ${#deleted[@]} merged branch(es):"
    printf '  %s\n' "${deleted[@]}"
else
    echo "No branches were deleted."
fi
